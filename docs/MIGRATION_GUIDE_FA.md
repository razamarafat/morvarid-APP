# راهنمای مهاجرت و استقرار دیتابیس Morvarid (Supabase)

این راهنما همراه فایل `supabase/master_schema.sql` طراحی شده و هدف آن رساندن پروژه به ساختار نهایی «قابل اتکا + ایمن + قابل اجرا» است.

## 1) پیش‌نیازهای خیلی مهم

### 1.1) نقش‌ها و مدل امنیت
سیستم نقش‌ها را از جدول `public.profiles.role` می‌خواند:
- `ADMIN`
- `REGISTRATION`
- `SALES`

تمام RLS بر پایه همین نقش و جدول واسط `public.user_farms` بسته شده است.

### 1.2) تاریخ‌ها
اپلیکیشن تاریخ‌ها را به صورت **`TEXT` با فرمت `YYYY/MM/DD`** (جلالی نرمال‌شده) نگه می‌دارد و روی آن مقایسه رشته‌ای انجام می‌دهد.
در اسکیما نهایی برای `daily_statistics.date` و `invoices.date` یک `CHECK` گذاشته شده تا فرمت خراب وارد دیتابیس نشود.

### 1.3) نکته حیاتی درباره ساخت کاربر (RPC `create_new_user`)
کد فرانت شما در `userStore.ts` این RPC را صدا می‌زند:
- `rpc('create_new_user', { email, password, user_metadata })`

این RPC باید بتواند **داخل Auth** کاربر بسازد. در Supabase این کار معمولاً با Admin API انجام می‌شود.

در `master_schema.sql` تابع `public.create_new_user(...)` طوری نوشته شده که:
- اگر تابع `auth.admin_create_user(...)` در پروژه موجود باشد، از آن استفاده کند.
- اگر موجود نباشد، با پیام واضح خطا بدهد.

> اگر در پروژه‌ی شما `auth.admin_create_user` وجود نداشته باشد (بسته به نسخه/تنظیمات)، راه‌حل «بی‌نقص و استاندارد» این است که ایجاد کاربر را به یک **Edge Function** با `service_role` منتقل کنید (نه به کلاینت). در این حالت فرانت باید به جای RPC دیتابیس، آن Edge Function را صدا بزند.

## 2) اجرای اسکریپت اصلی

### 2.1) بکاپ قبل از هر کاری
- از دیتابیس فعلی خروجی بگیرید (SQL/CSV)
- از جداول مهم حداقل این‌ها را جداگانه بکاپ بگیرید:
  - `profiles`
  - `farms`
  - `products`
  - `user_farms`
  - `daily_statistics`
  - `invoices`
  - `push_subscriptions`

### 2.2) اجرای `master_schema.sql`
1) Supabase Dashboard → SQL Editor
2) فایل `supabase/master_schema.sql` را اجرا کنید.

این اسکریپت:
- جدول جاافتاده‌ی `daily_quotes` را می‌سازد.
- ستون `profiles.notifications_enabled` را اضافه می‌کند.
- Constraint یکتایی حواله را روی `(invoice_number, product_id)` اعمال می‌کند.
- RLS را دقیق می‌کند.
- تریگرها و ایندکس‌ها را ایجاد می‌کند.

## 3) چک‌های بعد از اجرا

### 3.1) تست RLS
با یک کاربر غیرادمین:
- باید فقط فارم‌های تخصیص‌خورده را ببیند.
- باید فقط روی همان فارم‌ها بتواند `daily_statistics` و `invoices` را CRUD کند.

با کاربر ادمین:
- باید همه چیز را ببیند و مدیریت کند.

### 3.2) تست `daily_quotes`
- `quoteService` باید بتواند `select` روی `daily_quotes` انجام دهد.
- اگر قرار است ادمین quote درج کند، policy درج برای ادمین فعال است.

### 3.3) تست `notifications_enabled`
فعلاً کد شما این فیلد را از دیتابیس **نمی‌خواند/نمی‌نویسد** (فقط UI دارد).
اما دیتابیس آماده است.

برای تکمیل نهایی، باید یکی از این دو کار انجام شود:
- **گزینه A (پیشنهادی)**: در `fetchUsers` و `updateUser` و `handle_new_user` این فیلد هم مپ/آپدیت شود.
- **گزینه B**: اگر این قابلیت را نمی‌خواهید، فیلد UI حذف شود.

## 4) نکته سازگاری حواله (Invoice) با کد فعلی

- دیتابیس: یکتایی روی `(invoice_number, product_id)` است.
- کد فعلی: قبل از درج، فقط `invoice_number` را چک می‌کند.

نتیجه:
- ممکن است کد به اشتباه بگوید «تکراری» حتی وقتی محصول متفاوت است.

پیشنهاد اصلاح در کد (برای بعد از مهاجرت):
- Duplicate check باید روی زوج `(invoice_number, product_id)` انجام شود.

## 5) استراتژی مهاجرت داده‌ها (اگر دیتای قبلی دارید)

### 5.1) `products`
- محصولات پیش‌فرض با UUIDهای ثابت seed می‌شوند.
- اگر محصولات سفارشی دارید، به همان جدول insert می‌شوند.

### 5.2) `farms.product_ids`
در اسکیما نهایی همان ستون `TEXT[]` نگه داشته شده تا کد فعلی نشکند.
ولی با تریگر `validate_farm_product_ids` جلوی ورود ID نامعتبر گرفته می‌شود.

### 5.3) `date`های قبلی
اگر رکوردهایی با فرمت غیر `YYYY/MM/DD` دارید:
- قبل از اجرای اسکریپت، آنها را normalize کنید.
- چون بعد از اسکیما جدید، CHECK اجازه ذخیره فرمت خراب را نمی‌دهد.

## 6) جمع‌بندی تصمیمات معماری Part 2
- امنیت: RLS بر پایه `profiles.role` و `user_farms`.
- منطق حساس: با `SECURITY DEFINER` و Trigger برای جلوگیری از تغییرات حساس پروفایل.
- یکپارچگی داده: Check constraint برای تاریخ + یکتایی آمار و حواله + اعتبارسنجی `farms.product_ids`.
- پشتیبانی کامل از جداول استفاده‌شده توسط اپ: اضافه شدن `daily_quotes`.
